name: Transform Plugin Data

on:
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  transform-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
    
    - name: Test PAT Token
      run: |
        echo "Testing PAT Token permissions..."
        response=$(curl -L -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
          -H "User-Agent: GitHub-Action-Plugin-Transformer" \
          "https://api.github.com/user")
        
        if echo "$response" | jq -e '.login' > /dev/null 2>&1; then
          username=$(echo "$response" | jq -r '.login')
          echo "âœ… PAT Token authenticated as: $username"
        else
          echo "âŒ PAT Token authentication failed"
          echo "Response: $response"
          exit 1
        fi
    
    - name: Fetch original plugin data
      id: fetch-data
      run: |
        echo "å¼€å§‹è·å–åŸå§‹æ’ä»¶æ•°æ®..."
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "PAT_TOKEN æƒé™æ£€æŸ¥..."
        if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
          echo "âœ“ PAT_TOKEN å·²è®¾ç½®"
        else
          echo "âœ— PAT_TOKEN æœªè®¾ç½®"
        fi
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨å“åº”å’ŒHTTPçŠ¶æ€ç 
        temp_response="temp_response.txt"
        temp_headers="temp_headers.txt"
        
        # è·å–GitHubåŸå§‹æ–‡ä»¶å†…å®¹
        github_url="https://raw.githubusercontent.com/AstrBotDevs/AstrBot_Plugins_Collection/main/plugins.json"
        
        # ä½¿ç”¨curlè·å–æ•°æ®ï¼Œæ·»åŠ -Lå‚æ•°è‡ªåŠ¨è·Ÿéšé‡å®šå‘ï¼Œå¢åŠ é‡å®šå‘é™åˆ¶
        http_code=$(curl -L -s --max-time 30 --retry 3 --retry-delay 5 \
          --max-redirs 10 \
          -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
          -H "User-Agent: GitHub-Action-Plugin-Transformer" \
          -H "Accept: application/json" \
          -w "%{http_code}" \
          -D "$temp_headers" \
          -o "$temp_response" \
          "$github_url")
        
        curl_exit_code=$?
        
        # æ£€æŸ¥curlå‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
        if [ $curl_exit_code -ne 0 ]; then
          echo "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œcurlé€€å‡ºç : $curl_exit_code"
          case $curl_exit_code in
            5) echo "æ— æ³•è§£æä»£ç†" ;;
            6) echo "æ— æ³•è§£æä¸»æœºå" ;;
            7) echo "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨" ;;
            28) echo "è¯·æ±‚è¶…æ—¶" ;;
            35) echo "SSLè¿æ¥é”™è¯¯" ;;
            47) echo "é‡å®šå‘æ¬¡æ•°è¿‡å¤š" ;;
            *) echo "å…¶ä»–ç½‘ç»œé”™è¯¯" ;;
          esac
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        echo "HTTPçŠ¶æ€ç : $http_code"
        
        # æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†é‡å®šå‘
        if [ -f "$temp_headers" ]; then
          redirect_count=$(grep -c "^HTTP/" "$temp_headers" || echo "1")
          if [ "$redirect_count" -gt 1 ]; then
            echo "â„¹ï¸ æ£€æµ‹åˆ°é‡å®šå‘ï¼Œå…±å‘ç”Ÿ $((redirect_count - 1)) æ¬¡é‡å®šå‘"
            # æ˜¾ç¤ºé‡å®šå‘é“¾
            echo "é‡å®šå‘è¯¦æƒ…:"
            grep -E "^(HTTP/|Location:)" "$temp_headers" | head -10
          fi
        fi
        
        # æ£€æŸ¥HTTPçŠ¶æ€ç 
        if [ "$http_code" -ne 200 ]; then
          echo "âŒ æœ€ç»ˆè¿”å›é200çŠ¶æ€ç : $http_code"
          case $http_code in
            301) echo "æ°¸ä¹…é‡å®šå‘ (301 Moved Permanently) - å¯èƒ½éœ€è¦æ›´æ–°URL" ;;
            302) echo "ä¸´æ—¶é‡å®šå‘ (302 Found)" ;;
            404) echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä»“åº“ä¸å¯è®¿é—® (404 Not Found)" ;;
            403) echo "è®¿é—®è¢«æ‹’ç»ï¼Œå¯èƒ½æ˜¯APIé™åˆ¶ (403 Forbidden)" ;;
            500) echo "GitHubæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ (500 Internal Server Error)" ;;
            *) echo "HTTPé”™è¯¯çŠ¶æ€ç : $http_code" ;;
          esac
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # è¯»å–å“åº”å†…å®¹
        if [ ! -f "$temp_response" ]; then
          echo "âŒ å“åº”æ–‡ä»¶ä¸å­˜åœ¨"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        response=$(cat "$temp_response")
        
        # æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©º
        if [ -z "$response" ] || [ "$response" = "" ]; then
          echo "âŒ è·å–åˆ°çš„å“åº”ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥å“åº”å¤§å°
        response_size=$(wc -c < "$temp_response")
        if [ "$response_size" -lt 50 ]; then
          echo "âŒ å“åº”å†…å®¹è¿‡å° ($response_size å­—èŠ‚)ï¼Œå¯èƒ½æ˜¯é”™è¯¯å“åº”"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
        if ! echo "$response" | jq . > /dev/null 2>&1; then
          echo "âŒ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œè·³è¿‡æ›´æ–°"
          echo "Content preview: $(echo "$response" | head -c 200)"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # æ£€æŸ¥JSONæ˜¯å¦ä¸ºç©ºå¯¹è±¡æˆ–ç©ºæ•°ç»„
        if [ "$response" = "{}" ] || [ "$response" = "[]" ] || [ "$response" = "null" ]; then
          echo "âŒ è·å–åˆ°ç©ºçš„JSONæ•°æ®ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_update=false" >> $GITHUB_OUTPUT
          rm -f "$temp_response" "$temp_headers"
          exit 0
        fi
        
        # ä¿å­˜åŸå§‹æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$response" > original_plugins.json
        echo "should_update=true" >> $GITHUB_OUTPUT
        echo "âœ… æˆåŠŸè·å–åŸå§‹æ’ä»¶æ•°æ® ($response_size å­—èŠ‚)"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f "$temp_response" "$temp_headers"
    
    - name: Load existing cache for fallback
      if: steps.fetch-data.outputs.should_update == 'true'
      id: load-cache
      run: |
        echo "æ£€æŸ¥ç°æœ‰ç¼“å­˜æ–‡ä»¶..."
        if [ -f plugin_cache_original.json ]; then
          echo "å‘ç°ç°æœ‰ç¼“å­˜æ–‡ä»¶ï¼Œå°†ç”¨ä½œå›é€€æ•°æ®"
          cp plugin_cache_original.json existing_cache.json
          echo "has_existing_cache=true" >> $GITHUB_OUTPUT
        else
          echo "æ²¡æœ‰ç°æœ‰ç¼“å­˜æ–‡ä»¶"
          echo "has_existing_cache=false" >> $GITHUB_OUTPUT
        fi

    - name: Get GitHub API info for repositories
      if: steps.fetch-data.outputs.should_update == 'true'
      id: get-repo-info
      run: |
        echo "å¼€å§‹è·å–ä»“åº“ä¿¡æ¯..."
        
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä»“åº“ä¿¡æ¯
        echo "{}" > repo_info.json
        
        # åˆå§‹åŒ–ç»Ÿè®¡è®¡æ•°å™¨
        total_repos=0
        success_count=0
        failed_count=0
        deleted_count=0
        network_error_count=0
        redirect_count=0
        
        # é‡è¯•é…ç½®
        MAX_RETRIES=5
        BASE_DELAY=2
        MAX_DELAY=30
        
        # é‡è¯•å‡½æ•°
        retry_api_call() {
          local owner="$1"
          local repo="$2"
          local attempt="$3"
          
          # è®¡ç®—é€€é¿å»¶è¿Ÿ (æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨)
          local delay=$((BASE_DELAY * (2 ** (attempt - 1))))
          if [ $delay -gt $MAX_DELAY ]; then
            delay=$MAX_DELAY
          fi
          # æ·»åŠ éšæœºæŠ–åŠ¨ (0-50% çš„å»¶è¿Ÿæ—¶é—´)
          local jitter=$((RANDOM % (delay / 2 + 1)))
          delay=$((delay + jitter))
          
          echo "    ç¬¬ $attempt æ¬¡å°è¯• (å»¶è¿Ÿ ${delay}s)..."
          sleep $delay
          
          # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ•è·å“åº”å¤´
          local temp_headers="temp_api_headers_${total_repos}_${attempt}.txt"
          
          # æ‰§è¡ŒAPIè°ƒç”¨ï¼Œå¢å¼ºç½‘ç»œé…ç½®
          local response=$(curl -L -s \
            --max-time 20 \
            --connect-timeout 10 \
            --retry 0 \
            --max-redirs 5 \
            --keepalive-time 60 \
            --tcp-nodelay \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "User-Agent: GitHub-Action-Plugin-Transformer" \
            -H "Connection: keep-alive" \
            -D "$temp_headers" \
            -w "HTTPSTATUS:%{http_code}:CURL_EXIT:%{exitcode}" \
            "https://api.github.com/repos/$owner/$repo" 2>/dev/null || echo "CURL_ERROR:-1")
          
          # è§£æå“åº”
          if [[ "$response" == "CURL_ERROR"* ]]; then
            rm -f "$temp_headers"
            return 1
          fi
          
          # æå–çŠ¶æ€ç å’Œcurlé€€å‡ºç 
          local http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          local curl_exit=$(echo "$response" | grep -o "CURL_EXIT:[0-9]*" | cut -d: -f2)
          local body=$(echo "$response" | sed 's/HTTPSTATUS:[0-9]*:CURL_EXIT:[0-9]*$//')
          
          # æ£€æŸ¥curlé€€å‡ºç 
          if [ "$curl_exit" != "0" ]; then
            echo "    CURLé”™è¯¯ç : $curl_exit"
            rm -f "$temp_headers"
            return 1
          fi
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç æ˜¯å¦éœ€è¦é‡è¯•
          case "$http_code" in
            200)
              # éªŒè¯å“åº”æ˜¯å¦ä¸ºæœ‰æ•ˆJSON
              if echo "$body" | jq -e '.stargazers_count' > /dev/null 2>&1; then
                echo "$body"
                rm -f "$temp_headers"
                return 0
              else
                echo "    å“åº”ä¸æ˜¯æœ‰æ•ˆJSON"
                rm -f "$temp_headers"
                return 1
              fi
              ;;
            429|502|503|504)
              # è¿™äº›çŠ¶æ€ç åº”è¯¥é‡è¯•
              echo "    ä¸´æ—¶é”™è¯¯ HTTP $http_codeï¼Œå°†é‡è¯•"
              rm -f "$temp_headers"
              return 1
              ;;
            301|302|404|403)
              # è¿™äº›çŠ¶æ€ç ä¸åº”è¯¥é‡è¯•ï¼Œç›´æ¥è¿”å›
              echo "$body:HTTP:$http_code"
              rm -f "$temp_headers"
              return 0
              ;;
            *)
              echo "    æœªçŸ¥HTTPçŠ¶æ€ç : $http_code"
              rm -f "$temp_headers"
              return 1
              ;;
          esac
        }
        
        # ä»åŸå§‹æ•°æ®ä¸­æå–æ‰€æœ‰ä»“åº“URL
        jq -r 'to_entries[] | .value.repo // empty' original_plugins.json | while read -r repo_url; do
          # æå–GitHubç”¨æˆ·åå’Œä»“åº“å
          if [[ "$repo_url" =~ https://github\.com/([^/]+)/([^/]+) ]]; then
            owner="${BASH_REMATCH[1]}"
            repo="${BASH_REMATCH[2]}"
            total_repos=$((total_repos + 1))
            
            echo "[$total_repos] è·å–ä»“åº“ä¿¡æ¯: $owner/$repo"
            
            # æ‰§è¡Œé‡è¯•é€»è¾‘
            api_response=""
            success=false
            
            for attempt in $(seq 1 $MAX_RETRIES); do
              if [ $attempt -eq 1 ]; then
                echo "  åˆæ¬¡å°è¯•..."
                # ç¬¬ä¸€æ¬¡å°è¯•ï¼Œæ— å»¶è¿Ÿ
                temp_headers="temp_api_headers_${total_repos}_1.txt"
                api_response=$(curl -L -s \
                  --max-time 15 \
                  --connect-timeout 8 \
                  --retry 0 \
                  --max-redirs 5 \
                  -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "User-Agent: GitHub-Action-Plugin-Transformer" \
                  -D "$temp_headers" \
                  -w "HTTPSTATUS:%{http_code}" \
                  "https://api.github.com/repos/$owner/$repo" 2>/dev/null || echo "CURL_ERROR")
                
                if [[ "$api_response" != "CURL_ERROR" ]]; then
                  http_code=$(echo "$api_response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
                  api_response=$(echo "$api_response" | sed 's/HTTPSTATUS:[0-9]*$//')
                  
                  # æ£€æŸ¥æ˜¯å¦æˆåŠŸæˆ–ä¸éœ€è¦é‡è¯•çš„é”™è¯¯
                  case "$http_code" in
                    200)
                      if echo "$api_response" | jq -e '.stargazers_count' > /dev/null 2>&1; then
                        success=true
                        break
                      fi
                      ;;
                    301|302|404|403)
                      # ä¸éœ€è¦é‡è¯•çš„çŠ¶æ€ç 
                      success=true
                      break
                      ;;
                    429|502|503|504)
                      # éœ€è¦é‡è¯•çš„çŠ¶æ€ç 
                      echo "  ä¸´æ—¶é”™è¯¯ HTTP $http_codeï¼Œå‡†å¤‡é‡è¯•"
                      ;;
                  esac
                fi
                rm -f "$temp_headers"
              else
                # é‡è¯•è°ƒç”¨
                retry_response=$(retry_api_call "$owner" "$repo" "$attempt")
                if [ $? -eq 0 ]; then
                  api_response="$retry_response"
                  success=true
                  break
                fi
              fi
              
              # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œæ˜¾ç¤ºé‡è¯•ä¿¡æ¯
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "  å°è¯• $attempt/$MAX_RETRIES å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•..."
              fi
            done
            
            # å¤„ç†æœ€ç»ˆç»“æœ
            stars=0
            updated_at=""
            version=""
            status="unknown"
            
            if [ "$success" = true ]; then
              # æ£€æŸ¥æ˜¯å¦åŒ…å«HTTPçŠ¶æ€ç ä¿¡æ¯
              if [[ "$api_response" == *":HTTP:"* ]]; then
                http_code=$(echo "$api_response" | grep -o ":HTTP:[0-9]*" | cut -d: -f3)
                api_response=$(echo "$api_response" | sed 's/:HTTP:[0-9]*$//')
              fi
              
              case "$http_code" in
                200)
                  if echo "$api_response" | jq -e '.stargazers_count' > /dev/null 2>&1; then
                    stars=$(echo "$api_response" | jq -r '.stargazers_count // 0')
                    updated_at=$(echo "$api_response" | jq -r '.updated_at // ""')
                    success_count=$((success_count + 1))
                    status="success"
                    
                    echo "  âœ… æˆåŠŸ - Stars: $stars, æ›´æ–°æ—¶é—´: $updated_at"
                    
                    # è·å–metadataç‰ˆæœ¬
                    for metadata_file in "metadata.yml" "metadata.yaml"; do
                      metadata_response=$(curl -L -s --max-time 10 --max-redirs 3 \
                        -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
                        -H "Accept: application/vnd.github.v3.raw" \
                        -H "User-Agent: GitHub-Action-Plugin-Transformer" \
                        "https://api.github.com/repos/$owner/$repo/contents/$metadata_file" 2>/dev/null || echo "{}")
                      
                      if [[ ! "$metadata_response" =~ "Not Found" ]] && [[ ! "$metadata_response" =~ "Bad Gateway" ]]; then
                        # æ£€æŸ¥æ˜¯å¦æ˜¯base64ç¼–ç çš„å†…å®¹
                        if echo "$metadata_response" | jq -e '.content' > /dev/null 2>&1; then
                          metadata_content=$(echo "$metadata_response" | jq -r '.content' | base64 -d 2>/dev/null || echo "")
                        else
                          metadata_content="$metadata_response"
                        fi
                        
                        # å°è¯•è§£æYAMLå¹¶æå–ç‰ˆæœ¬
                        if [ ! -z "$metadata_content" ]; then
                          parsed_version=$(echo "$metadata_content" | grep -E "^version:\s*['\"]?([^'\"]+)['\"]?" | sed -E "s/version:\s*['\"]?([^'\"]+)['\"]?/\1/" || echo "")
                          # å»é™¤æ³¨é‡Šå’Œå¤šä½™çš„ç©ºç™½å­—ç¬¦
                          cleaned_version=$(echo "$parsed_version" | sed -E 's/[#].*$//' | sed -E 's/\r$//' | xargs)
                          if [ ! -z "$cleaned_version" ]; then
                            version="$cleaned_version"
                            break
                          fi
                        fi
                      fi
                    done
                  fi
                  ;;
                301|302)
                  echo "  ğŸ”„ ä»“åº“é‡å®šå‘ ($http_code)"
                  redirect_count=$((redirect_count + 1))
                  status="redirected"
                  ;;
                404)
                  echo "  ğŸ—‘ï¸  ä»“åº“å·²åˆ é™¤æˆ–ä¸å¯è®¿é—® (404)"
                  deleted_count=$((deleted_count + 1))
                  status="deleted"
                  ;;
                403)
                  echo "  âš ï¸  APIé™åˆ¶æˆ–è®¿é—®è¢«æ‹’ç» (403)"
                  failed_count=$((failed_count + 1))
                  status="api_limit"
                  ;;
              esac
            else
              echo "  âŒ æ‰€æœ‰é‡è¯•å‡å¤±è´¥"
              network_error_count=$((network_error_count + 1))
              status="network_error"
            fi
            
            # å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
            if [ "$status" != "success" ] && [ "${{ steps.load-cache.outputs.has_existing_cache }}" = "true" ]; then
              cached_data=$(jq -r --arg url "$repo_url" '.data // {} | to_entries[] | select(.value.repo == $url) | .value | {stars: .stars, updated_at: .updated_at, version: .version}' existing_cache.json 2>/dev/null || echo "{}")
              
              if [ "$cached_data" != "{}" ] && [ "$cached_data" != "" ]; then
                cached_stars=$(echo "$cached_data" | jq -r '.stars // 0')
                cached_updated=$(echo "$cached_data" | jq -r '.updated_at // ""')
                cached_version=$(echo "$cached_data" | jq -r '.version // ""')
                
                if [ "$cached_stars" != "0" ] || [ "$cached_updated" != "" ]; then
                  echo "  ğŸ”„ ä½¿ç”¨ç¼“å­˜æ•°æ®: Stars: $cached_stars"
                  stars="$cached_stars"
                  updated_at="$cached_updated"
                  version="$cached_version"
                  status="cached"
                fi
              fi
            fi
            
            # å°†ä¿¡æ¯æ·»åŠ åˆ°repo_info.json
            jq --arg url "$repo_url" \
               --arg stars "$stars" \
               --arg updated "$updated_at" \
               --arg version "$version" \
               --arg status "$status" \
               '. + {($url): {stars: ($stars | tonumber), updated_at: $updated, version: $version, status: $status}}' \
               repo_info.json > temp_repo_info.json && mv temp_repo_info.json repo_info.json
            
            # æ·»åŠ åŸºç¡€å»¶è¿Ÿé¿å…APIé™åˆ¶
            sleep 0.5
          fi
        done
        
        echo ""
        echo "ğŸ“Š ä»“åº“ä¿¡æ¯è·å–ç»Ÿè®¡:"
        echo "  æ€»è®¡: $total_repos ä¸ªä»“åº“"
        echo "  âœ… æˆåŠŸ: $success_count"
        echo "  ğŸ”„ ä½¿ç”¨ç¼“å­˜: $(jq '[.[] | select(.status == "cached")] | length' repo_info.json)"
        echo "  ğŸ”„ é‡å®šå‘: $redirect_count"
        echo "  ğŸ—‘ï¸  å·²åˆ é™¤: $deleted_count"
        echo "  ğŸŒ ç½‘ç»œé”™è¯¯: $network_error_count"
        echo "  âŒ å…¶ä»–å¤±è´¥: $failed_count"
        echo ""
        
        # æˆåŠŸç‡æ£€æŸ¥
        if [ $total_repos -gt 0 ]; then
          success_rate=$((success_count * 100 / total_repos))
          echo "ğŸ“ˆ æˆåŠŸç‡: $success_rate%"
          
          if [ $success_rate -lt 50 ]; then
            echo "âš ï¸  è­¦å‘Š: æˆåŠŸç‡è¿‡ä½ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜æˆ–GitHubæœåŠ¡å¼‚å¸¸"
            if [ "${{ steps.load-cache.outputs.has_existing_cache }}" = "true" ]; then
              echo "å·²å¯ç”¨ç¼“å­˜å›é€€æœºåˆ¶"
            fi
          fi
        fi
        
        echo "âœ… ä»“åº“ä¿¡æ¯è·å–å®Œæˆ"
    
    - name: Transform plugin data
      if: steps.fetch-data.outputs.should_update == 'true'
      run: |
        echo "å¼€å§‹è½¬æ¢æ’ä»¶æ•°æ®æ ¼å¼..."
        
        # ä½¿ç”¨jqè½¬æ¢æ•°æ®æ ¼å¼ï¼Œå¢åŠ å®¹é”™å¤„ç†
        jq --slurpfile repo_info repo_info.json '
        to_entries | map({
          key: .key,
          value: (
            .value + {
              # ä¿æŒåŸæœ‰å­—æ®µ
              desc: .value.desc,
              author: .value.author,
              repo: .value.repo,
              tags: (.value.tags // [])
            } +
            # ä»…å½“social_linkå­˜åœ¨ä¸”ä¸ä¸ºç©ºæ—¶æ·»åŠ 
            (if .value.social_link then { social_link: .value.social_link } else {} end) + 
            # æ·»åŠ æ–°å­—æ®µï¼Œä»repo_infoä¸­è·å–
            (if .value.repo and ($repo_info[0][.value.repo]) then
              ($repo_info[0][.value.repo] | {
                stars: .stars,
                updated_at: .updated_at,
                version: (if .version != "" then .version else "1.0.0" end)
              })
            else
              {
                stars: 0,
                version: "1.0.0"
              }
            end)
          )
        }) | from_entries' original_plugins.json > temp_plugin_cache_original.json
        
        # æ ¼å¼åŒ–JSONä½¿å…¶æ›´æ˜“è¯»
        jq . temp_plugin_cache_original.json > plugin_cache_original.json
        
        echo "âœ… æ•°æ®è½¬æ¢å®Œæˆ"
        
        # æ˜¾ç¤ºè½¬æ¢ç»Ÿè®¡
        original_count=$(jq 'keys | length' original_plugins.json)
        new_count=$(jq 'keys | length' plugin_cache_original.json)
        
        # ç»Ÿè®¡ä¸åŒçŠ¶æ€çš„ä»“åº“
        success_repos=$(jq '[.[] | select(.status == "success")] | length' repo_info.json)
        cached_repos=$(jq '[.[] | select(.status == "cached")] | length' repo_info.json)
        redirected_repos=$(jq '[.[] | select(.status == "redirected")] | length' repo_info.json)
        deleted_repos=$(jq '[.[] | select(.status == "deleted")] | length' repo_info.json)
        failed_repos=$(jq '[.[] | select(.status != "success" and .status != "cached" and .status != "redirected")] | length' repo_info.json)
        
        echo ""
        echo "ğŸ“Š è½¬æ¢ç»Ÿè®¡:"
        echo "  æ’ä»¶æ•°é‡: $original_count -> $new_count"
        echo "  âœ… å®æ—¶æ•°æ®: $success_repos ä¸ªä»“åº“"
        echo "  ğŸ”„ ç¼“å­˜æ•°æ®: $cached_repos ä¸ªä»“åº“"
        echo "  ğŸ”„ é‡å®šå‘: $redirected_repos ä¸ªä»“åº“"
        echo "  ğŸ—‘ï¸  å·²åˆ é™¤: $deleted_repos ä¸ªä»“åº“"
        echo "  âŒ æ— æ•°æ®: $failed_repos ä¸ªä»“åº“"
        
        # åˆ—å‡ºé‡å®šå‘çš„ä»“åº“
        if [ "$redirected_repos" -gt 0 ]; then
          echo ""
          echo "ğŸ”„ å‘ç”Ÿé‡å®šå‘çš„ä»“åº“åˆ—è¡¨:"
          jq -r 'to_entries[] | select(.value.status == "redirected") | "  - " + .key' repo_info.json
        fi
        
        # åˆ—å‡ºå·²åˆ é™¤çš„ä»“åº“
        if [ "$deleted_repos" -gt 0 ]; then
          echo ""
          echo "ğŸ—‘ï¸  å·²åˆ é™¤çš„ä»“åº“åˆ—è¡¨:"
          jq -r 'to_entries[] | select(.value.status == "deleted") | "  - " + .key' repo_info.json
        fi
        
        # åˆ—å‡ºå®Œå…¨å¤±è´¥çš„ä»“åº“
        if [ "$failed_repos" -gt 0 ]; then
          echo ""
          echo "âŒ æ— æ³•è·å–æ•°æ®çš„ä»“åº“:"
          jq -r 'to_entries[] | select(.value.status != "success" and .value.status != "cached" and .value.status != "deleted" and .value.status != "redirected") | "  - " + .key + " (" + .value.status + ")"' repo_info.json
        fi
    
    - name: Check for changes
      if: steps.fetch-data.outputs.should_update == 'true'
      id: git-check
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶çŠ¶æ€..."
        ls -la
        
        # é…ç½®Gitï¼ˆä½¿ç”¨PAT_TOKENè¿›è¡Œè®¤è¯ï¼‰
        git config --local user.email "cacheigcrystal@gmail.com"
        git config --local user.name "IGCrystal-Ghost"
        
        echo "æ£€æŸ¥è¿œç¨‹ä»“åº“æ˜¯å¦å­˜åœ¨ plugin_cache_original.json..."
        if git ls-tree --name-only -r origin/main | grep -q "^plugin_cache_original.json$"; then
          echo "æ–‡ä»¶åœ¨è¿œç¨‹ä»“åº“ä¸­å·²å­˜åœ¨"
          remote_exists="true"
        else
          echo "æ–‡ä»¶åœ¨è¿œç¨‹ä»“åº“ä¸­ä¸å­˜åœ¨"
          remote_exists="false"
        fi
        
        echo "æ£€æŸ¥æœ¬åœ° plugin_cache_original.json æ˜¯å¦å­˜åœ¨..."
        if [ -f plugin_cache_original.json ]; then
          echo "æ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°: $(wc -c < plugin_cache_original.json) bytes"
          # éªŒè¯JSONæ ¼å¼
          if jq empty plugin_cache_original.json > /dev/null 2>&1; then
            echo "âœ… JSONæ ¼å¼æœ‰æ•ˆ"
          else
            echo "âŒ JSONæ ¼å¼æ— æ•ˆ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -f plugin_cache_original.json ]; then
          if [ "$remote_exists" = "true" ]; then
            # æ–‡ä»¶åœ¨è¿œç¨‹å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å˜æ›´
            git add plugin_cache_original.json  # å…ˆæ·»åŠ åˆ°æš‚å­˜åŒºä»¥ä¾¿æ¯”è¾ƒ
            if git diff --cached --exit-code plugin_cache_original.json > /dev/null 2>&1; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°æ–‡ä»¶å†…å®¹å˜æ›´"
              echo "å˜æ›´è¯¦æƒ…:"
              git diff --cached plugin_cache_original.json
            fi
          else
            # æ–‡ä»¶åœ¨è¿œç¨‹ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ–°æ–‡ä»¶
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… è¿™æ˜¯æ–°æ–‡ä»¶ï¼Œéœ€è¦æäº¤"
            # é¢„å…ˆæ·»åŠ åˆ°æš‚å­˜åŒº
            git add plugin_cache_original.json
          fi
        else
          # æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âŒ æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤"
          exit 1
        fi
        
        # è¾“å‡º Git çŠ¶æ€ä»¥ä¾¿è°ƒè¯•
        echo "Git çŠ¶æ€:"
        git status
    
    - name: Commit and push changes
      if: steps.fetch-data.outputs.should_update == 'true' && steps.git-check.outputs.has_changes == 'true'
      run: |
        # Gité…ç½®å·²åœ¨ä¸Šä¸€æ­¥è®¾ç½®
        
        # éªŒè¯è®¤è¯çŠ¶æ€
        echo "éªŒè¯Gitè®¤è¯çŠ¶æ€..."
        if git ls-remote origin HEAD > /dev/null 2>&1; then
          echo "âœ… Gitè®¤è¯æˆåŠŸ"
        else
          echo "âŒ Gitè®¤è¯å¤±è´¥ï¼Œæ£€æŸ¥PAT_TOKENæƒé™"
          exit 1
        fi
        
        # æ·»åŠ å’Œæäº¤æ–‡ä»¶
        git add plugin_cache_original.json
        
        # è·å–ç»Ÿè®¡ä¿¡æ¯ç”¨äºæäº¤ä¿¡æ¯
        total_plugins=$(jq '.data | keys | length' plugin_cache_original.json 2>/dev/null || echo "0")
        success_repos=$(jq '[.[] | select(.status == "success")] | length' repo_info.json 2>/dev/null || echo "0")
        
        commit_message="ğŸ”„ Update plugin cache: $total_plugins plugins, $success_repos fresh updates - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        git commit -m "$commit_message"
        
        # æ¨é€æ›´æ”¹
        echo "æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
        if git push origin HEAD; then
          echo "âœ… æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“"
        else
          echo "âŒ æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜"
          exit 1
        fi
    
    - name: Clean up
      if: always()
      run: |
        # æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
        rm -f temp_plugin_cache_original.json temp_response.txt temp_headers.txt original_plugins.json repo_info.json temp_repo_info.json existing_cache.json temp_api_headers_*.txt
        echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
    
    - name: Summary
      if: always()
      run: |
        if [ "${{ steps.fetch-data.outputs.should_update }}" = "true" ]; then
          if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ’ä»¶æ•°æ®å·²æˆåŠŸè½¬æ¢å¹¶æäº¤"
            
            # æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
            if [ -f plugin_cache_original.json ]; then
              total_plugins=$(jq 'keys | length' plugin_cache_original.json)
              echo "ğŸ“Š æœ€ç»ˆç»“æœ: $total_plugins ä¸ªæ’ä»¶å·²æ›´æ–°"
            fi
          else
            echo "â„¹ï¸ æ•°æ®è·å–å’Œè½¬æ¢æˆåŠŸï¼Œä½†å†…å®¹æœªå‘ç”Ÿå˜åŒ–"
          fi
        else
          echo "âŒ ç”±äºç½‘ç»œé—®é¢˜ã€GitHubæœåŠ¡é”™è¯¯æˆ–æ•°æ®å¼‚å¸¸ï¼Œè·³è¿‡äº†æ•°æ®è½¬æ¢"
          echo "è¯·æ£€æŸ¥GitHubæœåŠ¡çŠ¶æ€æˆ–æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯è¯¦æƒ…"
        fi
        
        echo ""
        echo "ğŸ” è®¤è¯å¢å¼ºè¯´æ˜:"
        echo "  - æ‰€æœ‰GitHub APIè¯·æ±‚éƒ½ä½¿ç”¨PAT_TOKENè®¤è¯"
        echo "  - æé«˜äº†APIè®¿é—®é™åˆ¶ï¼ˆ5000/å°æ—¶ vs 60/å°æ—¶ï¼‰"
        echo "  - å¢å¼ºäº†å¯¹ç§æœ‰ä»“åº“çš„è®¿é—®èƒ½åŠ›"
        echo "  - æ·»åŠ äº†APIä½¿ç”¨æƒ…å†µç›‘æ§"
        
        echo ""
        echo "ğŸ’¡ å®¹é”™æœºåˆ¶è¯´æ˜:"
        echo "  - è‡ªåŠ¨è·Ÿéšé‡å®šå‘: å¤„ç†301/302ç­‰é‡å®šå‘å“åº”"
        echo "  - åˆ åº“/404: ç»§ç»­å¤„ç†å…¶ä»–ä»“åº“ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰"
        echo "  - ç½‘ç»œé”™è¯¯: è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œå¤±è´¥åä½¿ç”¨ç¼“å­˜æ•°æ®"
        echo "  - APIé™åˆ¶: ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå»¶é•¿è¯·æ±‚é—´éš”"
        echo "  - æˆåŠŸç‡ä½: ä¸»è¦ä¾èµ–ç°æœ‰ç¼“å­˜ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§"
